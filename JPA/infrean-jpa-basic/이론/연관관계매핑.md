# 다대일
다대일 관계에서 외래키(FK)는 항상 다(多)쪽에 있다. 따라서 연관관계의 주인은 항상 다(多)쪽이다.([연관관계의 주인](https://github.com/oyatrij/my-study/blob/main/JPA/infrean-jpa-basic/%EC%9D%B4%EB%A1%A0/%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84%EC%9D%98%20%EC%A3%BC%EC%9D%B8.md))<br>

## 다대일 단방향
다음은 다대일 단방향 연관관계를 적용한 Entity 코드이다.<br>
```java
//Member Entity
@Entity
public class Member {
    @Id @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;

    private String username;

    @ManyToOne
    @JoinColumn(name = "TEAM_ID")
    private Team team; //TEAM 참조

    //Getter, Setter...
}

//Team Entity
@Entity
public class Team {
    @Id @GeneratedValue
    @Column(name = "TEAM_ID")
    private Long Id;

    private String name;

    //Getter, Setter
}
```

<br>

Member에서는 Team을 참조할 수 있지만 Team에서는 Member를 참조할 수 없기 때문에 이는 **다대일 단방향** 연관관계이다.<br>

## 다대일 양방향
다대일 양방향 관계는 두 엔티티에서 모두 다른 엔티티를 참조할 수 있다.

```java
//Member Entity
@Entity
public class Member {
    @Id @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;

    private String username;

    @ManyToOne
    @JoinColumn(name = "TEAM_ID")
    private Team team; //TEAM 참조

    //Getter, Setter...
}

//Team Entity
@Entity
public class Team {
    @Id @GeneratedValue
    @Column(name = "TEAM_ID")
    private Long Id;

    private String name;

    @OneToMany(mappedBy = "team")
    private List<Member> members = new ArrayList<Member>(); //Member 참조

    //Getter, Setter
}
```

양방향에서는 외래키(FK)가 있는 쪽, 여기에서는 FK가 `TEAM_ID`이니 Member Entity가 연관관계의 주인이다.<br>
연관관계의 주인인 Member엔티티에서는 FK를 관리하기위해 team을 사용한다.<br>
연관관계의 주인이 아닌 Team엔티티에서의 members는 조회를 위한 JPQL이나 객체 그래프 탐색을 위해 사용한다.<br>

<br>

---

<br>

# 일대다
일대다 관계에서는 다(多)쪽 객체를 담아야 하기때문에 자바 컬랙션인 Collection.List, Set, Map 중 하나를 사용해야한다.<br>
일대다 관계는 외래키가없는 엔티티에서 연관관계의 주인인 엔티티의 외래키를 관리한다.<br>

```java
//Member Entity
@Entity
public class Member {
    @Id @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;

    private String username;

    //Getter, Setter
}

//Team Entity
@Entity
public class Team {
    @Id @GeneratedValue
    @Column(name = "TEAM_ID")
    private Long Id;

    private String name;

    @OneToMany
    @JoinColumn(name = "TEAM_ID") //Member 테이블의 TEAM_ID 연관관계의 주인에 (FK)
    private List<Member> members = new ArrayList<Member>

    //Getter, Setter
}
```

<br>

일대다 단방향 매핑의 단점으 연관관계의 주인의 FK를 연관관계의 주인이 아닌 다른 테이블에서 관리한다는 것이다.<br>
외래키를 다른 테이블에서 관리하게되면 INSERT 후 UPDATE를 추가로 실행해야한다는 것이다.<br>
아래 코드에서 확인 해 보자

```java
Member member1 = new Member("Member1");
Member member2 = new Member("Member2");
Team team1 = new Team("Team1");

team1.getMembers().add(member1);
team1.getMembers().add(member2);

em.persist(member1);//INSERT member1
em.persist(member2);//INSERT member2
em.persist(team1);  //INSERT team1
                    //UPDATE member1 FK, UPDATE member2 FK
                    //UPDATE 추가 발생
```

일대다 단방향 매핑의 단점을 해결하기 위해 양방향 매핑을 시도해야한다.<br>
하지만 `@OneToMany`는 연관관계의 주인이 될 수 없다.<br>
FK는 항상 다(多)쪽에 있기 때문이다.<br>
양방향 매핑을 완전히 구현할 수 없는 것은 아니다.<br>
다(多)쪽에 아래 코드로 외래키 컬럼을 읽기전용으로 추가하면된다.

```java
@ManyToOne
@JoinColumn(name = "TEAM_ID", insertable = false, updatable = false)
private Team team;
```

<br>

하지만 이 방법은 양방향 매핑처럼 보이도록 한 것 뿐이다.<br>
될수있으면 **다대일 양방향 매핑**을 사용하도록 하자.








